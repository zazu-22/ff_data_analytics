______________________________________________________________________

## title: NFLverse & Multi-Source Snapshot Alignment Plan version: 1.0 date: 2025-11-06

# NFLverse & Multi-Source Snapshot Alignment Plan

This plan describes how we will stabilize snapshot handling for NFLverse and align snapshot governance across all sources (Sleeper, Commissioner Sheets, FFAnalytics, KTC), preparing for cloud storage and Prefect orchestration.

## Objectives

- Parameterize snapshot selection in dbt (baseline + latest) to avoid hardcoded dates
- Centralize snapshot metadata and validation across sources
- Guard sample artifacts to prevent accidental promotion into production snapshots
- Prepare cloud-ready storage layout and a safe sync utility
- Model Prefect flows with snapshot currency and anomaly checks

## Scope

- Sources: NFLverse (weekly, snap_counts, ff_opportunity, refs), Commissioner Sheets, Sleeper, FFAnalytics projections, KTC (later)
- Models: dbt staging for nflverse weekly/snap_counts, shared ops metadata view, tests
- Tooling: coverage/delta checks, sync utility, CI hooks, Prefect flows

## Design Decisions

### 1) Snapshot Selection (dbt)

- Add macro `keep_latest_plus(source_glob, baseline_dt=None, min_dt=None)` that selects MAX(dt) and, optionally, a baseline snapshot or minimum dt range.
- Replace hardcoded snapshot filters in `stg_nflverse__player_stats` and `stg_nflverse__snap_counts` with the macro, using env-var globs and a `var('NFLVERSE_BASELINE_DT')`.
- Keep window-based deduplication to prefer latest when overlaps exist.

Example usage in staging:

```sql
and {{
  keep_latest_plus(
    env_var("RAW_NFLVERSE_WEEKLY_GLOB", "data/raw/nflverse/weekly/dt=*/*.parquet"),
    baseline_dt=var("NFLVERSE_BASELINE_DT", "2025-10-01")
  )
}}
```

### 2) Sample Guardrails (ingest shim + layout)

- Relocate any legacy samples under `data/raw/<source>/_samples/<dataset>/...`.
- Extend `src/ingest/nflverse/shim.py::load_nflverse(..., samples: bool=False)` to route outputs to `.../_samples/...` when `samples=True`.
- dbt globs remain `.../<dataset>/dt=*/*.parquet` (won't match `_samples`), preventing accidental reads.

### 3) Shared Snapshot Metadata (dbt ops view)

- Create an ops view that reads `_meta.json` across sources to provide a unified registry of snapshots (source, dataset, dt, asof_datetime, source_version), enabling freshness checks.

### 4) Validation Tooling (pre-dbt)

- Extend `tools/analyze_snapshot_coverage.py` to:
  - Compare latest-snapshot row deltas across sources
  - Report season/week coverage and gaps (e.g., weekly vs snap_counts)
  - Sample-join to `dim_player_id_xref` to report mapping coverage by dataset/week

### 5) Cloud-Ready Storage

- Document GCS layout and retention in `docs/ops/cloud_storage_migration.md`.
- Add `tools/sync_snapshots.py` to safely mirror local ↔ GCS with `_samples` exclusions and no overwrite of populated partitions unless `--force`.

### 6) Prefect-Orchestrated Ingestion

- Define flows in `src/flows/` for nflverse ingest, reference refresh, Sleeper updates, and dbt selections.
- Embed snapshot currency checks, anomaly thresholds, and notifications in tasks.

## Execution Plan

1. Implement macro `keep_latest_plus` and update nflverse staging models to use env-var globs + baseline var
2. Add ops snapshot metadata view for `_meta.json` across sources
3. Enhance coverage analyzer with deltas and mapping coverage checks
4. Draft cloud storage migration blueprint; implement guarded sync utility
5. Add interim CI steps for coverage checks and dbt run/test
6. Model initial Prefect flows (ingest → validate → dbt)
7. Update documentation and SPEC checklist alignment

## Risks & Mitigations

- Schema drift across snapshots → use `union_by_name=true` and monitor null rates by column
- Partial/late snapshots → baseline+latest pattern plus freshness tests
- Mapping gaps for snap_counts (linemen) → report unmapped rates; add targeted alias updates if needed

## Metrics of Success

- No manual snapshot date edits required for weekly updates
- Coverage report shows no gaps across latest snapshots for in-scope seasons/weeks
- CI surfaces freshness/anomaly failures prior to dbt promotion
- Prefect run emits consistent snapshot currency and anomaly notifications

## References

- `dbt/ff_data_transform/models/staging/stg_nflverse__player_stats.sql`
- `dbt/ff_data_transform/models/staging/stg_nflverse__snap_counts.sql`
- `dbt/ff_data_transform/macros/get_latest_snapshot.sql`
- `tools/analyze_snapshot_coverage.py`
- `docs/spec/SPEC-1_v_2.3_implementation_checklist_v_0.md`
