# Handoff: Data Model v4 Planning Session (2025-09-29)

## What We Accomplished

1. **Identified and resolved two critical data model gaps:**

- FFanalytics projections integration (no implementation plan existed)
- Commissioner TRANSACTIONS tab (not being parsed; ~1,000 rows of trade history ignored)

2. **Created comprehensive design documentation:**

- Updated `docs/spec/refined_data_model_plan_v4.md` with two addenda:
- **v4.1**: Projections Integration (separate `fact_player_projections` table)
- **v4.2**: League Transaction History (`fact_league_transactions` table)
- Updated `docs/spec/SPEC-1_v_2.2_implementation_checklist_v_1.md` with revised sequencing

3. **Documented architectural decisions:**

- Created ADR-007: Separate fact tables for actuals vs projections (rejected nullable keys)
- Created ADR-008: League transaction history integration (enables trade analysis)
- Updated ADR index and SPEC-1 references

## Current State

**Status:** Data model v4.0 approved with addenda. Implementation sequencing clarified.

**Key Architectural Decisions:**

- **2√ó2 Model**: Separate facts for actuals (`fact_player_stats`) and projections (`fact_player_projections`)
- **Real-world in facts, fantasy in marts**: Scoring rules applied in mart layer via `dim_scoring_rule` seeds
- **Per-game vs weekly grain**: Actuals require `game_id`; projections use `horizon` ('weekly', 'full_season', 'rest_of_season')
- **Transaction history**: Asset-per-row grain matching raw TRANSACTIONS tab structure

**3-Phase Implementation:**

1. **Phase 1 (BLOCKER)**: Create dbt seeds (`dim_player_id_xref`, `dim_pick`, `dim_asset`, `dim_scoring_rule`, etc.)
1. **Phase 2**: Four parallel tracks after seeds:

- Track A: NFL Actuals (nflverse ‚Üí fact_player_stats)
- Track B: League Data (TRANSACTIONS ‚Üí fact_league_transactions)
- Track C: Market Data (KTC ‚Üí fact_asset_market_values)
- Track D: Projections (FFanalytics ‚Üí fact_player_projections)

3. **Phase 3**: Integration marts (variance, trade valuations, ops)

## Critical Files Updated

- `docs/spec/refined_data_model_plan_v4.md` - Added v4.1 and v4.2 addenda
- `docs/spec/SPEC-1_v_2.2_implementation_checklist_v_1.md` - Revised sequencing, updated sign-off criteria
- `docs/adr/ADR-007-separate-fact-tables-actuals-vs-projections.md` - NEW
- `docs/adr/ADR-008-league-transaction-history-integration.md` - NEW
- `docs/adr/README.md` - Added ADR-007 and ADR-008 to index
- `docs/spec/SPEC-1_v_2.2.md` - Added ADR links to specification

## Next Steps (Priority Order)

### 1. IMMEDIATE BLOCKER - Create Seeds (Phase 1)

**Critical Path:** Transform reference data into dbt seeds for new architecture

#### a) `dim_scoring_rule` (Half-PPR league scoring)

- **Source reference**: `docs/spec/league_config_data/rules_constants.json` (scoring section) and `config/scoring/sleeper_scoring_rules.yaml`
- **Action**: Create **NEW** dbt seed CSV with SCD2 structure:
- Columns: `rule_id`, `rule_name`, `stat_name`, `points_per_unit`, `valid_from`, `valid_to`, `is_current`
- Values: Half-PPR (0.5 per reception), passing yards (0.04), rushing/receiving yards (0.1), TDs, etc.
- Include IDP scoring: tackles (0.5), sacks (1.5), interceptions (6.0), etc.
- **Validation**: Compare transformed values to reference files; discard reference after confirmation

#### b) `dim_franchise` (League team/owner dimension with SCD2)

- **Source reference**: `docs/spec/league_config_data/franchises.json`, `owner_to_franchise_mapping.json`, `sleeper_league_mapping.json`
- **Action**: Create **NEW** dbt seed CSV with franchise and ownership history:
- Columns: `franchise_id`, `franchise_name`, `division`, `established_year`, `owner_id`, `owner_name`, `owner_valid_from`, `owner_valid_to`,
  `is_current_owner`
- 12 franchises (F001-F012) with ownership transitions tracked
- Map to Sleeper roster IDs for integration
- **Note**: Reference files show ownership history (e.g., F001: Jon‚ÜíAlec‚ÜíJason); transform to SCD2 rows

#### c) `dim_player_id_xref` (Provider IDs ‚Üí canonical player_id)

- **Source**: nflreadr player dictionaries (via nflverse shim)
- **Action**: Generate seed from nflverse data; include mappings:
- `player_id` (canonical), `gsis_id`, `pfr_id`, `sleeper_id`, `display_name`, `position`, `team`
- **Required for**: TRANSACTIONS parsing (player name ‚Üí ID), projections mapping

#### d) `dim_name_alias` (Fuzzy name matching)

- **Source**: Derived from `dim_player_id_xref` + manual additions
- **Action**: Create seed with alternate spellings/variations
- **Required for**: TRANSACTIONS tab player name resolution

#### e) `dim_pick` (Draft pick dimension)

- **Source**: League constants (5 rounds, 12 teams = 60 picks per year)
- **Action**: Generate seed with `pick_id`, `season`, `round`, `overall_pick`, `round_slot`
- **Required for**: TRANSACTIONS tab draft pick assets

#### f) `dim_asset` (Unified player/pick/cap asset catalog)

- **Source**: Union of players + picks
- **Action**: Create seed linking `asset_id` to `asset_type` (player/pick/cap_space), `player_id`, `pick_id`

#### g) Neutral stat dictionary

- **Source**: nflreadr stat definitions
- **Action**: Map provider-specific stat names to canonical neutral names

**IMPORTANT**: `docs/spec/league_config_data/` files are **reference only** from scrapped codebase. Do NOT copy directly. Extract source info, transform to
new schema, then **remove that directory** when seeds are finalized.

### 2. After Seeds - Parallel Tracks (Phase 2)

- Implement TRANSACTIONS parsing in `src/ingest/sheets/commissioner_parser.py`
- Complete FFanalytics weighted aggregation (8 sources to consensus) -- see '<https://ffanalytics.fantasyfootballanalytics.net/reference/index.html>' for reference documentation on the ffanalytics R package functions; we'll need to use several of them to scrape the data, create our custom scoring, generate projected points, projection tables, and more. This will need to be done carefully -- check with Jason for any questions.
- Create staging models: `stg_sheets__transactions`, `stg_ffanalytics__projections`
- Build core facts: `fact_player_stats`, `fact_player_projections`, `fact_league_transactions`

### 3. Integration (Phase 3)

- Build marts: `mart_projection_variance`, `mart_trade_valuations`
- Wire CI/CD schedules
- Test LKG fallback

## Key Context for Next Session

- **Sample data exists**: TRANSACTIONS tab already copied to `samples/sheets/TRANSACTIONS/` (not yet parsed)
- **FFanalytics raw scrape working**: 8 sources, 3,698 projections; needs weighted aggregation
- **Scoring validated**: `config/scoring/sleeper_scoring_rules.yaml` matches reference data (Half-PPR: 0.5)
- **Franchise mappings available**: Owner‚ÜíFranchise with SCD2 history; Sleeper roster_id mappings documented
- **Seeds are the critical path**: Nothing in Phase 2 can start without player ID mapping and franchise dimension
- **All decisions documented**: ADRs capture rationale; v4 addenda have SQL snippets ready to implement

## Reference Data Status

**`docs/spec/league_config_data/`** - Source information from previous codebase:

- ‚úÖ Available for extraction: Scoring rules (Half-PPR values), franchise definitions, owner mappings, Sleeper roster IDs
- ‚ö†Ô∏è **DO NOT use as-is**: Transform to new dbt seed format; discard originals after validation
- üóëÔ∏è **Remove directory** once seeds finalized and validated

**Scoring Confirmation**:

- Half-PPR: 0.5 points per reception ‚úì
- Passing: 0.04 per yard, 4.0 per TD ‚úì
- Rushing/Receiving: 0.1 per yard, 6.0 per TD ‚úì
- IDP: Complex scoring including tackles, sacks, INTs ‚úì
- Current season rules stable (no refresh needed from Sleeper API during season)

**Franchise Dimension Strategy**:

- Use stable `franchise_id` (F001-F012) as primary key
- Track ownership changes via SCD2 (e.g., F001: Jon 2012‚ÜíAlec 2013-2024‚ÜíJason 2025+)
- Map to Sleeper `roster_id` for integration (12 rosters match 12 franchises)
- Commissioner sheets use owner names; Sleeper uses user_id; dimension bridges both
