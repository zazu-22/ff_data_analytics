version: 2

models:
  - name: stg_sheets__transactions
    description: |
      Staged Commissioner TRANSACTIONS sheet with dimension joins and validation flags.

      **Grain**: One row per transaction event per asset
      **Source**: Commissioner Google Sheet TRANSACTIONS tab → parse_transactions()
      **Key Transformations**:
      - Timeframe → transaction_date mapping
      - Owner name → franchise_id (SCD Type 2 temporal join)
      - Player crosswalk mapping (100% coverage via dim_name_alias)
      - Contract validation flag calculation
      - JSON casting for DuckDB compatibility

      **Contract Validation**:
      Extensions intentionally have length mismatches because:
      - Contract field: shows extension amount only (e.g., 24/1)
      - Split field: shows full remaining schedule (e.g., 6-6-24)
      See: docs/analysis/TRANSACTIONS_contract_validation_analysis.md

    columns:
      - name: transaction_id_unique
        description: "Unique identifier for this transaction-asset row (PK)"
        data_tests:
          - unique
          - not_null

      - name: transaction_id
        description: "Transaction event ID (groups multi-asset trades)"
        data_tests:
          - not_null

      - name: player_key
        description: |
          Composite identifier to prevent grain violations from unmapped players.
          - Mapped players: player_id (mfl_id as varchar)
          - Unmapped players: player_name
          - Non-players: asset-specific prefix + transaction_id_unique
        data_tests:
          - not_null

      - name: transaction_type
        description: "Refined transaction type (11 types)"
        data_tests:
          - not_null
          - accepted_values:
              arguments:
                values:
                  - rookie_draft_selection
                  - cut
                  - trade
                  - waiver_claim
                  - fasa_signing
                  - faad_ufa_signing
                  - faad_rfa_matched
                  - offseason_ufa_signing
                  - contract_extension
                  - franchise_tag
                  - amnesty_cut
                  - unknown

      - name: asset_type
        description: "Asset classification"
        data_tests:
          - not_null
          - accepted_values:
              arguments:
                values:
                  - player
                  - pick
                  - defense
                  - cap_space
                  - unknown

      - name: transaction_date
        description: "Derived transaction date (from timeframe + period_type)"
        data_tests:
          - not_null

      - name: transaction_year
        description: "Year extracted from transaction_date"
        data_tests:
          - not_null

      - name: timeframe_string
        description: "Original timeframe from sheet (e.g., '2024 Offseason')"
        data_tests:
          - not_null
          - relationships:
              arguments:
                to: ref('dim_timeframe')
                field: timeframe_string

      - name: from_franchise_id
        description: "Source franchise (null for waiver wire)"
        data_tests:
          - relationships:
              arguments:
                to: ref('dim_franchise')
                field: franchise_id
              config:
                where: "from_franchise_id is not null"

      - name: to_franchise_id
        description: "Destination franchise (null for waiver wire)"
        data_tests:
          - relationships:
              arguments:
                to: ref('dim_franchise')
                field: franchise_id
              config:
                where: "to_franchise_id is not null"

      - name: player_id
        description: "Canonical player ID (mfl_id from crosswalk)"
        data_tests:
          - relationships:
              arguments:
                to: ref('dim_player_id_xref')
                field: player_id
              config:
                where: "asset_type = 'player' and player_id != -1"

      - name: pick_id
        description: |
          Standardized pick ID (YYYY_R#_P##).

          Note: Not all pick_ids exist in dim_pick. Compensatory picks (e.g., P14+)
          and traded duplicate slots are valid but not in the standard seed.
        data_tests:
          - relationships:
              arguments:
                to: ref('dim_pick')
                field: pick_id
              config:
                where: "asset_type = 'pick' and pick_id is not null and pick_id not like '%_TBD'"
                severity: warn  # Compensatory picks expected to fail

      - name: contract_split_json
        description: "Year-by-year cap hits as JSON array for DuckDB"

      - name: has_contract_length_mismatch
        description: "Flag: len(split) != years (expected for Extensions)"

      - name: has_contract_sum_mismatch
        description: "Flag: sum(split) != total (rounding or errors)"

      - name: validation_notes
        description: "Explanation of validation issues"

      - name: faad_award_sequence
        description: |
          Immutable FAAD award ordering (1-indexed per season) persisted during
          ingestion. Keeps compensatory pick sequencing stable even if commissioner
          transaction_ids are edited after the draft.

      - name: season
        description: "NFL season year for this transaction"

      - name: period_type
        description: "Season phase: offseason, regular_season, or playoffs"

      - name: week
        description: "NFL week number (null for offseason transactions)"

      - name: sort_sequence
        description: "Intra-week ordering for transactions in same timeframe"

      - name: from_franchise_name
        description: "Source franchise name from dim_franchise"

      - name: to_franchise_name
        description: "Destination franchise name from dim_franchise"

      - name: player_name
        description: "Player name from Commissioner sheet"

      - name: position
        description: "Player position from Commissioner sheet"

      - name: pick_season
        description: "Draft year for this pick (e.g., 2025)"

      - name: pick_round
        description: "Draft round number for this pick"

      - name: pick_overall_number
        description: "Overall pick number within the draft"

      - name: pick_id_raw
        description: "Raw pick identifier from Commissioner sheet"

      - name: pick_original_owner
        description: "Original owner of this draft pick"

      - name: round
        description: "Draft round (legacy field, prefer pick_round)"

      - name: pick_number
        description: "Pick number within round (legacy field)"

      - name: contract_total
        description: "Total contract value in dollars"

      - name: contract_years
        description: "Contract length in years"

      - name: contract_split_array
        description: "Year-by-year cap hit breakdown as array"

      - name: rfa_matched
        description: "Flag: true if this is an RFA match transaction"

      - name: faad_compensation
        description: "FAAD compensation awarded (draft pick, cap space, etc.)"

      - name: faad_compensation_text
        description: "Human-readable FAAD compensation description"

      - name: contract_raw
        description: "Raw contract string from Commissioner sheet"

      - name: split_raw
        description: "Raw contract split string from Commissioner sheet"

      - name: transaction_type_raw
        description: "Original transaction type from Commissioner sheet before refinement"

      - name: from_owner_name
        description: "Source owner name from Commissioner sheet (for franchise mapping)"

      - name: to_owner_name
        description: "Destination owner name from Commissioner sheet (for franchise mapping)"
