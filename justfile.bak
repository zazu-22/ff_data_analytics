# justfile for ff_data_analytics
# Task runner replacing Makefile with cleaner syntax
# Run `just --list` or `just help` to see available commands

set dotenv-load := true
set shell := ["bash", "-uc"]

# Default recipe - show help
default: help

# Show all available commands organized by category
help:
    @echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
    @echo "  ff_data_analytics - Available Commands"
    @echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
    @echo ""
    @echo "ğŸš€ QUICK START WORKFLOWS:"
    @echo "  ingest-with-xref     Fast ingestion (nflverse â†’ xref â†’ sheets, sleeper, ktc)"
    @echo "  ingest-all           Full ingestion (includes ffanalytics - 15-20 min)"
    @echo "  sql-all              Run all SQL quality checks"
    @echo "  pre-commit           Run all pre-commit hooks"
    @echo ""
    @echo "ğŸ“¥ DATA INGESTION (individual sources):"
    @echo "  ingest-nflverse      Ingest NFLverse datasets (weekly, snaps, opportunity, playerids)"
    @echo "  ingest-sheets        Ingest Commissioner Google Sheets"
    @echo "  ingest-sleeper-players  Ingest Sleeper player database"
    @echo "  ingest-ktc           Ingest KeepTradeCut dynasty values (1QB)"
    @echo "  ingest-ffanalytics   Ingest FFanalytics projections (slow - 15-20 min)"
    @echo ""
    @echo "ğŸ”„ DBT WORKFLOWS:"
    @echo "  dbt-xref             Build dim_player_id_xref (required for ingestion)"
    @echo "  dbt-deps             Install dbt package dependencies"
    @echo "  dbt-seed             Seed dbt sources"
    @echo "  dbt-run              Run dbt models (use 'just dbt-run <args>')"
    @echo "  dbt-test             Run dbt tests (use 'just dbt-test <args>')"
    @echo "  validate-franchise-mapping  Run franchise mapping validation tests"
    @echo ""
    @echo "âœ… CODE QUALITY - Python:"
    @echo "  lintcheck            Check Python code (ruff, yamllint, mdformat, lintr)"
    @echo "  lintfix              Auto-fix Python code issues"
    @echo "  typecheck            Run type checks (pyrefly)"
    @echo "  typeinfer <path>     Auto-add type annotations"
    @echo ""
    @echo "âœ… CODE QUALITY - SQL:"
    @echo "  sqlfmt               Format SQL files"
    @echo "  sqlfmt-check         Check SQL formatting"
    @echo "  sqlcheck             Lint SQL (sqlfluff)"
    @echo "  sqlfix               Auto-fix SQL issues"
    @echo "  dbt-compile-check    Validate SQL syntax (dbt compile)"
    @echo "  dbt-opiner-check     Check dbt best practices"
    @echo ""
    @echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"

# ============================================================================
# QUICK START WORKFLOWS
# ============================================================================

# Fast ingestion workflow (excludes FFanalytics)
ingest-with-xref:
    #!/usr/bin/env bash
    set -euo pipefail
    echo ""
    echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
    echo "  Fast Ingestion Workflow (excludes FFanalytics)"
    echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
    echo ""
    echo "[1/5] Ingesting NFLverse data (provides player IDs)..."
    echo "â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€"
    just ingest-nflverse
    echo ""
    echo "[2/5] Building dim_player_id_xref (player name crosswalk)..."
    echo "â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€"
    just dbt-xref
    echo ""
    echo "[3/5] Ingesting Commissioner sheets (requires xref)..."
    echo "â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€"
    just ingest-sheets
    echo ""
    echo "[4/5] Ingesting Sleeper data (requires xref)..."
    echo "â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€"
    just ingest-sleeper-players
    echo ""
    echo "[5/5] Ingesting KTC dynasty values (requires xref)..."
    echo "â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€"
    just ingest-ktc
    echo ""
    echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
    echo "  âœ… Fast ingestion complete!"
    echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
    echo ""
    echo "Note: Run 'just ingest-ffanalytics' separately if needed (15-20 min)"
    echo ""

# Full ingestion workflow (includes FFanalytics - SLOW!)
ingest-all:
    #!/usr/bin/env bash
    set -euo pipefail
    echo ""
    echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
    echo "  Full Ingestion Workflow (includes FFanalytics - SLOW!)"
    echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
    echo ""
    echo "[1/6] Ingesting NFLverse data (provides player IDs)..."
    echo "â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€"
    just ingest-nflverse
    echo ""
    echo "[2/6] Building dim_player_id_xref (player name crosswalk)..."
    echo "â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€"
    just dbt-xref
    echo ""
    echo "[3/6] Ingesting Commissioner sheets (requires xref)..."
    echo "â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€"
    just ingest-sheets
    echo ""
    echo "[4/6] Ingesting Sleeper data (requires xref)..."
    echo "â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€"
    just ingest-sleeper-players
    echo ""
    echo "[5/6] Ingesting KTC dynasty values (requires xref)..."
    echo "â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€"
    just ingest-ktc
    echo ""
    echo "[6/6] Ingesting FFanalytics projections (âš ï¸  15-20 min)..."
    echo "â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€"
    just ingest-ffanalytics
    echo ""
    echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
    echo "  âœ… Full ingestion workflow complete!"
    echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
    echo ""

# Run all SQL quality checks (format + lint + compile + opiner)
sql-all:
    #!/usr/bin/env bash
    set -euo pipefail
    echo "=========================================="
    echo "ALL SQL QUALITY CHECKS"
    echo "=========================================="
    echo ""
    echo "[1/4] Checking SQL formatting..."
    uv run sqlfmt --check dbt/ff_data_transform/models/**/*.sql && echo "  âœ“ Formatting OK" || echo "  âœ— Formatting issues found (run 'just sqlfmt' to fix)"
    echo ""
    echo "[2/4] Running sqlfluff lint (selective)..."
    uv run sqlfluff lint dbt/ff_data_transform/models/ && echo "  âœ“ sqlfluff OK" || echo "  âœ— sqlfluff found issues"
    echo ""
    echo "[3/4] Validating SQL syntax (dbt compile)..."
    mkdir -p dbt/ff_data_transform/target
    uv run env \
        EXTERNAL_ROOT="$(pwd)/data/raw" \
        DBT_DUCKDB_PATH="$(pwd)/dbt/ff_data_transform/target/dev.duckdb" \
        dbt compile --project-dir dbt/ff_data_transform --profiles-dir dbt/ff_data_transform && echo "  âœ“ Syntax validation OK" || echo "  âœ— Syntax errors found"
    echo ""
    echo "[4/4] Checking dbt best practices (dbt-opiner)..."
    cd dbt/ff_data_transform && \
        EXTERNAL_ROOT="$(pwd)/../../data/raw" \
        DBT_DUCKDB_PATH="$(pwd)/target/dev.duckdb" \
        uv run dbt deps --project-dir . --profiles-dir . || true
    cd dbt/ff_data_transform && \
        EXTERNAL_ROOT="$(pwd)/../../data/raw" \
        DBT_DUCKDB_PATH="$(pwd)/target/dev.duckdb" \
        uv run dbt-opiner lint --all-files --force-compile
    echo ""
    echo "=========================================="
    echo "ALL SQL QUALITY CHECKS COMPLETE"
    echo "=========================================="

# Run pre-commit hooks
pre-commit:
    #!/usr/bin/env bash
    set -euo pipefail
    echo "=========================================="
    echo "PRE-COMMIT HOOKS"
    echo "=========================================="
    echo ""
    echo "Running all pre-commit hooks..."
    uv run pre-commit run --all-files && echo "  âœ“ pre-commit completed successfully" || echo "  âœ— pre-commit had failures"
    echo ""
    echo "=========================================="
    echo "PRE-COMMIT COMPLETE"
    echo "=========================================="

# ============================================================================
# DATA INGESTION (individual sources)
# ============================================================================

# Ingest all NFLverse datasets
ingest-nflverse:
    #!/usr/bin/env bash
    set -euo pipefail
    echo "Ingesting all NFLverse datasets..."
    echo "â†’ Ingesting ff_playerids (player ID crosswalk)"
    uv run python -c "from src.ingest.nflverse.shim import load_nflverse; load_nflverse('ff_playerids')"
    echo "â†’ Ingesting weekly player stats (2025 season)"
    uv run python -c "from src.ingest.nflverse.shim import load_nflverse; load_nflverse('weekly', seasons=[2025])"
    echo "â†’ Ingesting snap counts (2025 season)"
    uv run python -c "from src.ingest.nflverse.shim import load_nflverse; load_nflverse('snap_counts', seasons=[2025])"
    echo "â†’ Ingesting fantasy opportunity (2025 season)"
    uv run python -c "from src.ingest.nflverse.shim import load_nflverse; load_nflverse('ff_opportunity', seasons=[2025])"
    echo "âœ… NFLverse ingestion complete"

# Ingest league sheets locally
ingest-sheets:
    @echo "Ingesting league sheets locally"
    uv run python scripts/ingest/ingest_commissioner_sheet.py

# Ingest Sleeper player database
ingest-sleeper-players:
    @echo "Ingesting Sleeper player database"
    uv run python -m src.ingest.sleeper.loader players

# Ingest FFanalytics projections (rest-of-season)
ingest-ffanalytics:
    @echo "Ingesting FFanalytics projections (rest-of-season)"
    uv run python -c "from src.ingest.ffanalytics.loader import load_projections_ros; load_projections_ros()"

# Ingest KeepTradeCut dynasty market values (1QB)
ingest-ktc:
    #!/usr/bin/env bash
    set -euo pipefail
    echo "Ingesting KeepTradeCut dynasty market values (1QB)"
    echo "â†’ Ingesting players"
    uv run python -c "from ingest.ktc.registry import load_players; load_players()"
    echo "â†’ Ingesting picks"
    uv run python -c "from ingest.ktc.registry import load_picks; load_picks()"
    echo "âœ… KTC ingestion complete"

# ============================================================================
# DBT WORKFLOWS
# ============================================================================

# Build dim_player_id_xref (required for ingestion)
dbt-xref:
    #!/usr/bin/env bash
    set -euo pipefail
    echo "Building dim_player_id_xref"
    mkdir -p dbt/ff_data_transform/target
    uv run env \
        EXTERNAL_ROOT="$(pwd)/data/raw" \
        DBT_DUCKDB_PATH="$(pwd)/dbt/ff_data_transform/target/dev.duckdb" \
        dbt run --project-dir dbt/ff_data_transform --profiles-dir dbt/ff_data_transform --select dim_player_id_xref

# Install dbt package dependencies
dbt-deps *ARGS:
    #!/usr/bin/env bash
    set -euo pipefail
    echo "Installing dbt package dependencies"
    uv run env \
        DBT_DUCKDB_PATH="$(pwd)/dbt/ff_data_transform/target/dev.duckdb" \
        dbt deps --project-dir dbt/ff_data_transform --profiles-dir dbt/ff_data_transform {{ ARGS }}

# Seed dbt sources
dbt-seed *ARGS:
    #!/usr/bin/env bash
    set -euo pipefail
    echo "Seeding dbt sources"
    mkdir -p dbt/ff_data_transform/target
    uv run env \
        EXTERNAL_ROOT="$(pwd)/data/raw" \
        DBT_DUCKDB_PATH="$(pwd)/dbt/ff_data_transform/target/dev.duckdb" \
        dbt seed --project-dir dbt/ff_data_transform --profiles-dir dbt/ff_data_transform {{ ARGS }}

# Run dbt models locally (DuckDB)
dbt-run *ARGS:
    #!/usr/bin/env bash
    set -euo pipefail
    echo "Running dbt (ensure dbt-duckdb is installed)"
    mkdir -p dbt/ff_data_transform/target
    uv run env \
        EXTERNAL_ROOT="$(pwd)/data/raw" \
        DBT_DUCKDB_PATH="$(pwd)/dbt/ff_data_transform/target/dev.duckdb" \
        dbt run --project-dir dbt/ff_data_transform --profiles-dir dbt/ff_data_transform {{ ARGS }}

# Run dbt tests locally
dbt-test *ARGS:
    #!/usr/bin/env bash
    set -euo pipefail
    echo "Testing dbt models"
    mkdir -p dbt/ff_data_transform/target
    uv run env \
        EXTERNAL_ROOT="$(pwd)/data/raw" \
        DBT_DUCKDB_PATH="$(pwd)/dbt/ff_data_transform/target/dev.duckdb" \
        dbt test --project-dir dbt/ff_data_transform --profiles-dir dbt/ff_data_transform {{ ARGS }}

# Validate franchise mapping
validate-franchise-mapping:
    #!/usr/bin/env bash
    set -euo pipefail
    echo "Validating franchise mapping..."
    mkdir -p dbt/ff_data_transform/target
    uv run env \
        EXTERNAL_ROOT="$(pwd)/data/raw" \
        DBT_DUCKDB_PATH="$(pwd)/dbt/ff_data_transform/target/dev.duckdb" \
        dbt test \
            --select tag:franchise_mapping \
            --project-dir dbt/ff_data_transform \
            --profiles-dir dbt/ff_data_transform
    echo "âœ… Franchise mapping validation complete"

# ============================================================================
# CODE QUALITY - Python
# ============================================================================

# Run linter checks
lintcheck:
    #!/usr/bin/env bash
    set -euo pipefail
    echo "=========================================="
    echo "LINTER CHECKS"
    echo "=========================================="
    echo ""
    echo "[1/5] Running ruff check..."
    uv run ruff check . && echo "  âœ“ ruff completed successfully" || echo "  âœ— ruff had errors (continuing...)"
    echo ""
    echo "[2/5] Running sqlfluff lint..."
    uv run sqlfluff lint . && echo "  âœ“ sqlfluff completed successfully" || echo "  âœ— sqlfluff had errors (continuing...)"
    echo ""
    echo "[3/5] Running yamllint..."
    uv run yamllint --list-files . && echo "  âœ“ yamllint completed successfully" || echo "  âœ— yamllint had errors (continuing...)"
    echo ""
    echo "[4/5] Running mdformat check..."
    uv run mdformat --check . && echo "  âœ“ mdformat completed successfully" || echo "  âœ— mdformat had errors (continuing...)"
    echo ""
    echo "[5/5] Running lintr (R)..."
    Rscript -e "lintr::lint_dir('scripts/R')" && echo "  âœ“ lintr completed successfully" || echo "  âœ— lintr had errors (continuing...)"
    echo ""
    echo "=========================================="
    echo "LINTING CHECKS COMPLETE"
    echo "=========================================="

# Run linter auto-fixes
lintfix:
    #!/usr/bin/env bash
    set -euo pipefail
    echo "=========================================="
    echo "LINTER AUTO-FIX"
    echo "=========================================="
    echo ""
    echo "[1/5] Running ruff format ..."
    uv run ruff format . && echo "  âœ“ ruff format completed successfully" || echo "  âœ— ruff format had errors (continuing...)"
    echo ""
    echo "[2/5] Running ruff fix..."
    uv run ruff check . --fix && echo "  âœ“ ruff completed successfully" || echo "  âœ— ruff had errors (continuing...)"
    echo ""
    echo "[3/5] Running sqlfluff fix..."
    uv run sqlfluff fix . && echo "  âœ“ sqlfluff completed successfully" || echo "  âœ— sqlfluff had errors (continuing...)"
    echo ""
    echo "[4/5] Running mdformat..."
    uv run mdformat . && echo "  âœ“ mdformat completed successfully" || echo "  âœ— mdformat had errors (continuing...)"
    echo ""
    echo "[5/5] Running styler (R)..."
    Rscript -e "styler::style_dir('scripts/R')" && echo "  âœ“ styler completed successfully" || echo "  âœ— styler had errors (continuing...)"
    echo ""
    echo "=========================================="
    echo "LINTING FIXES COMPLETE"
    echo "=========================================="

# Run type checks
typecheck:
    #!/usr/bin/env bash
    set -euo pipefail
    echo "=========================================="
    echo "TYPE CHECKING"
    echo "=========================================="
    echo ""
    echo "Running pyrefly check (using config from pyproject.toml)..."
    uv run pyrefly check && echo "  âœ“ pyrefly completed successfully" || echo "  âœ— pyrefly found type errors"
    echo ""
    echo "=========================================="
    echo "TYPE CHECKING COMPLETE"
    echo "=========================================="

# Automatically add type annotations
typeinfer *ARGS:
    #!/usr/bin/env bash
    set -euo pipefail
    echo "=========================================="
    echo "TYPE INFERENCE"
    echo "=========================================="
    echo ""
    echo "Running pyrefly infer on {{ ARGS }}..."
    uv run pyrefly infer {{ ARGS }} && echo "  âœ“ pyrefly infer completed successfully" || echo "  âœ— pyrefly infer had errors"
    echo ""
    echo "=========================================="
    echo "TYPE INFERENCE COMPLETE"
    echo "=========================================="

# ============================================================================
# CODE QUALITY - SQL
# ============================================================================

# Format SQL files with sqlfmt
sqlfmt:
    #!/usr/bin/env bash
    set -euo pipefail
    echo "=========================================="
    echo "SQL FORMATTING (sqlfmt)"
    echo "=========================================="
    echo ""
    echo "Formatting SQL files with sqlfmt..."
    uv run sqlfmt dbt/ff_data_transform/models/**/*.sql && echo "  âœ“ sqlfmt completed successfully" || echo "  âœ— sqlfmt had errors"
    echo ""
    echo "=========================================="
    echo "SQL FORMATTING COMPLETE"
    echo "=========================================="

# Check SQL formatting without modifying files
sqlfmt-check:
    #!/usr/bin/env bash
    set -euo pipefail
    echo "=========================================="
    echo "SQL FORMAT CHECK (sqlfmt)"
    echo "=========================================="
    echo ""
    echo "Checking SQL formatting..."
    uv run sqlfmt --check dbt/ff_data_transform/models/**/*.sql && echo "  âœ“ All files properly formatted" || echo "  âœ— Some files need formatting (run 'just sqlfmt' to fix)"
    echo ""
    echo "=========================================="
    echo "SQL FORMAT CHECK COMPLETE"
    echo "=========================================="

# Run sqlfluff checks on dbt models (selective)
sqlcheck:
    #!/usr/bin/env bash
    set -euo pipefail
    echo "=========================================="
    echo "SQL LINTING (dbt models)"
    echo "=========================================="
    echo ""
    echo "Running sqlfluff lint..."
    echo "Note: DuckDB-specific files excluded via .sqlfluffignore"
    uv run sqlfluff lint dbt/ff_data_transform/models/ && echo "  âœ“ sqlfluff completed successfully" || echo "  âœ— sqlfluff found issues"
    echo ""
    echo "=========================================="
    echo "SQL LINTING COMPLETE"
    echo "=========================================="

# Run sqlfluff auto-fixes on dbt models
sqlfix:
    #!/usr/bin/env bash
    set -euo pipefail
    echo "=========================================="
    echo "SQL AUTO-FIX (dbt models)"
    echo "=========================================="
    echo ""
    echo "Running sqlfluff fix..."
    uv run sqlfluff fix dbt/ff_data_transform/models/ && echo "  âœ“ sqlfluff completed successfully" || echo "  âœ— sqlfluff had errors"
    echo ""
    echo "=========================================="
    echo "SQL AUTO-FIX COMPLETE"
    echo "=========================================="


# Run dbt compile for SQL syntax validation
dbt-compile-check:
    #!/usr/bin/env bash
    set -euo pipefail
    echo "=========================================="
    echo "DBT COMPILE CHECK (SQL syntax validation)"
    echo "=========================================="
    echo ""
    echo "Compiling dbt project to validate SQL syntax..."
    mkdir -p dbt/ff_data_transform/target
    uv run env \
        EXTERNAL_ROOT="$(pwd)/data/raw" \
        DBT_DUCKDB_PATH="$(pwd)/dbt/ff_data_transform/target/dev.duckdb" \
        dbt compile --project-dir dbt/ff_data_transform --profiles-dir dbt/ff_data_transform && echo "  âœ“ dbt compile completed successfully" || echo "  âœ— dbt compile found syntax errors"
    echo ""
    echo "=========================================="
    echo "DBT COMPILE CHECK COMPLETE"
    echo "=========================================="

# Run dbt-opiner for dbt best practices
dbt-opiner-check:
    #!/usr/bin/env bash
    set -euo pipefail
    echo "=========================================="
    echo "DBT-OPINER CHECK (dbt best practices)"
    echo "=========================================="
    echo ""
    echo "[1/3] Installing dbt dependencies..."
    mkdir -p dbt/ff_data_transform/target
    cd dbt/ff_data_transform && \
        EXTERNAL_ROOT="$(pwd)/../../data/raw" \
        DBT_DUCKDB_PATH="$(pwd)/target/dev.duckdb" \
        uv run dbt deps --project-dir . --profiles-dir . || true
    echo ""
    echo "[2/3] Running dbt-opiner lint with compilation..."
    echo "Note: Test files (tests/*.sql) are excluded - they're not dbt project nodes"
    cd dbt/ff_data_transform && \
        EXTERNAL_ROOT="$(pwd)/../../data/raw" \
        DBT_DUCKDB_PATH="$(pwd)/target/dev.duckdb" \
        uv run dbt-opiner lint --all-files --force-compile
    echo ""
    echo "=========================================="
    echo "DBT-OPINER CHECK COMPLETE"
    echo "=========================================="
