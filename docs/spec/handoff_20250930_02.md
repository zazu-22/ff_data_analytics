# Handoff: Phase 1 Seeds Complete (2025-09-30)

## What We Accomplished

### 1. Fixed Critical Storage Bug

- **Issue**: `storage.py` failing with relative paths
- **Fix**: PyArrow requires absolute paths or URI schemes; convert relative → absolute
- **Files**: `src/ingest/common/storage.py:113-116, 134-137`

### 2. Generated Full TRANSACTIONS Dataset

- **Size**: 3,912 transactions (full league history 2012-2025)
- **Timeframes**: 138 unique patterns (Offseason, Rookie Draft, FAAD, Preseason, Regular, Deadline)
- **Location**: `samples/sheets/TRANSACTIONS/` (from LEAGUE_SHEET_COPY)

### 3. Created 5 Critical Seeds

#### a) dim_player_id_xref.csv (2.0M, 12,133 players)

- **Full dataset** (not 1,000 row sample!)
- Deduped from nflverse `ff_playerids` (24,266 → 12,133 unique)
- 20 provider ID mappings: gsis_id, sleeper_id, espn_id, pfr_id, ktc_id, etc.
- Canonical `player_id` = `mfl_id`
- **Purpose**: All staging models join this for player ID resolution

#### b) dim_timeframe.csv (4.7K, 138 timeframes)

- Maps TRANSACTIONS strings → structured dates
- Example: `"2023 Week 11"` → `{season: 2023, period_type: regular, week: 11}`
- **Purpose**: Temporal joins for transaction → season resolution

#### c) dim_franchise.csv (1.5K, 20 ownership periods)

- **SCD Type 2**: season-based ownership history
- 12 franchises, multiple owners over time
- Example: F001 → Jon (2012), Alec (2013-2024), Jason (2025+)
- **Purpose**: Map `owner_name + season → franchise_id` for TRANSACTIONS parsing

#### d) dim_pick.csv (30K, 1,140 base picks)

- **Full history + future**: 2012-2030 (19 years × 5 rounds × 12 teams)
- Base picks only; compensatory picks added via TRANSACTIONS parsing
- **Purpose**: Asset tracking for trades, draft analysis
- **Documentation**: `dbt/ff_analytics/seeds/README_dim_pick_comp_picks.md`

#### e) dim_scoring_rule.csv (5.9K, 43 rules)

- **Source**: `rules_constants.json` (authoritative)
- **Validated**: Against Sleeper API export (PASS ✓)
- SCD Type 2 structure (all rules valid 2012-9999, is_current=true)
- Categories: passing, rushing, receiving, idp, team_dst, kicking
- **Purpose**: Calculate fantasy points from stats

## Current State

**Status**: Phase 1 seeds complete (5 of 9)

**Remaining Seeds (deferred to next session):**

- `dim_asset` - Union of players + picks (depends on dim_pick ✓)
- `stat_dictionary` - Provider stat name → canonical mapping
- `dim_name_alias` - Player name variations (derives from dim_player_id_xref ✓)
- `dim_owner` - Owner metadata (optional; might derive from dim_franchise)

**All critical blockers resolved:**

- ✅ Player ID crosswalk (12K players with 20 provider IDs)
- ✅ Franchise ownership history (SCD Type 2)
- ✅ Timeframe mapping (138 patterns)
- ✅ Draft picks (1,140 base + comp pick strategy)
- ✅ Scoring rules (43 rules, validated)

## Key Architectural Decisions Made

### 1. Player Identity: mfl_id as Canonical

- **Rationale**: Platform-agnostic, maps to 19 fantasy platforms
- **Impact**: ALL staging models must join `dim_player_id_xref`
- **Example**: `stg_nflverse__player_stats` joins on `gsis_id → mfl_id`

### 2. Franchise vs Owner: Franchises Persist

- **Critical concept**: Rosters belong to **franchises**, not owners
- **Example**: When Alec (F001 owner 2013-2024) traded in 2023, that transaction belongs to **F001**
- **Temporal join**: `owner_name + season BETWEEN season_start AND season_end → franchise_id`

### 3. Draft Picks: Base vs Compensatory

- **Base picks** (1,140): Known in advance, seeded now
- **Comp picks**: Awarded via RFA compensation (FAAD), added when parsing TRANSACTIONS
- **Overall pick number**: DERIVED at query time (cannot pre-calculate due to comp picks)
- **Pick value**: Use `ROW_NUMBER()` for overall position

### 4. Scoring Rules: SCD Type 2 Ready

- **Current**: All rules valid 2012-9999 (no changes yet)
- **Future-proof**: Structure supports rule changes per season
- **Validation**: Sleeper API export matches `rules_constants.json` (authoritative)

### 5. Timeframe Mapping: Commissioner Strings → Structured Dates

- **Challenge**: Inconsistent strings ("2023 Week 12 Deadline" vs "2023 Week 12")
- **Solution**: Regex parsing → `{season, period_type, week, sort_sequence}`
- **Purpose**: Enable `WHERE season = 2023 AND week BETWEEN 1 AND 12`

## Data Sources & Validation

### Authoritative Sources

1. **rules_constants.json** - League constitution (scoring, contracts, rules)
1. **franchises.json** - Franchise metadata + ownership history
1. **ff_playerids (nflverse)** - Player ID crosswalk (fetched live 2025-09-30)

### Validated Sources

- **Sleeper API** (sleeper_scoring_rules.yaml) - Matches rules_constants.json ✓
- **TRANSACTIONS tab** (LEAGUE_SHEET_COPY) - 3,912 transactions ✓

### Reference Data Cleanup

- **IMPORTANT**: `docs/spec/league_config_data/` used for seed generation
- **TODO**: Delete this directory after Phase 2 validation (no longer needed)

## Next Steps (Priority Order)

### Priority 1: Remaining Seeds (~10k tokens)

1. **dim_asset** - Union players + picks for trade valuation
1. **stat_dictionary** - Map provider stat names (nflverse, sleeper) → canonical
1. **dim_name_alias** - Player name variations for fuzzy matching

### Priority 2: Phase 2 Staging Models (~30k tokens)

1. **stg_nflverse\_\_player_stats** (UPDATE) - Add mfl_id crosswalk join
1. **stg_nflverse\_\_snap_counts** (NEW) - Uses pfr_id → mfl_id
1. **stg_nflverse\_\_ff_opportunity** (NEW) - Expected stats, variances

### Priority 3: Expand fact_player_stats (~20k tokens)

- UNION ALL three staging sources
- Add grain test (player_id, game_id, stat_name, provider, measure_domain, stat_kind)
- Validate row counts (~96 stat types × player-games)

## Critical Files Created

### Seeds

- `dbt/ff_analytics/seeds/dim_player_id_xref.csv` (2.0M)
- `dbt/ff_analytics/seeds/dim_timeframe.csv` (4.7K)
- `dbt/ff_analytics/seeds/dim_franchise.csv` (1.5K)
- `dbt/ff_analytics/seeds/dim_pick.csv` (30K)
- `dbt/ff_analytics/seeds/dim_scoring_rule.csv` (5.9K)
- `dbt/ff_analytics/seeds/README_dim_pick_comp_picks.md` (documentation)

### Samples

- `samples/nflverse/ff_playerids/` (12,133 players, full dataset)
- `samples/nflverse/snap_counts/` (1,000 rows, 2024 season)
- `samples/nflverse/ff_opportunity/` (1,000 rows, 159 columns)
- `samples/sheets/TRANSACTIONS/` (3,912 transactions, full history)
- `samples/sheets/TRANSACTIONS/timeframe_patterns.csv` (analysis)

### Code Fixes

- `src/ingest/common/storage.py` - Relative path handling for PyArrow

## Validation Checklist

**Before proceeding to Phase 2:**

- [ ] Load all seeds: `dbt seed --select dim_*`
- [ ] Validate primary keys: `dbt test --select dim_*`
- [ ] Check row counts match expectations
- [ ] Verify `dim_player_id_xref` no duplicates on mfl_id
- [ ] Verify `dim_franchise` covers all 12 franchises
- [ ] Verify `dim_pick` has 60 picks per year (2012-2030)
- [ ] Verify `dim_scoring_rule` has 43 rules

## Known Issues & Risks

### 1. Compensatory Pick Tracking

- **Risk**: TRANSACTIONS may not explicitly label comp picks
- **Mitigation**: RFA awards trigger comp pick creation; parse contract values
- **Validation**: Cross-check roster tabs vs computed pick holdings

### 2. Timeframe String Consistency

- **Risk**: Commissioner may use new timeframe patterns
- **Mitigation**: Regex patterns handle variations; log unmapped strings
- **Validation**: Check `dim_timeframe` coverage vs TRANSACTIONS

### 3. Player ID Coverage

- **Risk**: Not all nflverse players have mfl_id (especially historical)
- **Mitigation**: Use `player_id = -1` for unmapped players
- **Validation**: Monitor staging model unmapped counts (\<1% acceptable)

### 4. Scoring Rule Changes

- **Status**: No rule changes detected 2012-2025
- **Future**: If rules change, add new rows with updated `valid_from_season`
- **Validation**: Query Sleeper API annually to detect changes

## Questions for Next Session

1. **dim_asset structure**: Should we include both base + comp picks, or just base?
1. **stat_dictionary scope**: Which providers need mapping? (nflverse, sleeper, ffanalytics?)
1. **dim_name_alias generation**: Manual curation or algorithmic (fuzzy matching)?
1. **Reference data cleanup**: When to delete `docs/spec/league_config_data/`?

______________________________________________________________________

**Next developer**: Phase 1 seeds are **production-ready**. Validate with `dbt seed && dbt test`, then proceed to Phase 2 staging models. Reference ADR-009 (consolidated fact table) and ADR-010 (mfl_id canonical identity) for staging model design patterns.

**Estimated remaining work:**

- Phase 1 seeds: ~10k tokens
- Phase 2 staging: ~30k tokens
- Phase 2 fact table: ~20k tokens
- Phase 3 marts: ~15k tokens

Total: ~75k tokens (well within budget)
