# Handoff: Production Data Paths Implemented (2025-09-30)

## What We Accomplished

### 1. Loaded v4.3 Datasets to data/raw

✅ Successfully loaded 3 critical datasets following proper conventions:

- `ff_playerids`: 24,266 rows → data/raw/nflverse/ff_playerids/dt=2025-09-30/
- `snap_counts`: 2024 season → data/raw/nflverse/snap_counts/dt=2025-09-30/
- `ff_opportunity`: 2024 season → data/raw/nflverse/ff_opportunity/dt=2025-09-30/

### 2. Updated All Staging Models to Production Paths

✅ Changed from `samples/` to `data/raw/` structure:

**Before** (development):

```sql
'{{ env_var("RAW_NFLVERSE_WEEKLY_GLOB", "samples/nflverse/weekly/*.parquet") }}'
```

**After** (production-ready):

```sql
'{{ env_var("RAW_NFLVERSE_WEEKLY_GLOB", "data/raw/nflverse/weekly/dt=*/*.parquet") }}'
```

**Files updated**:

- `stg_nflverse__player_stats.sql` - Now reads from data/raw/nflverse/weekly/dt=\*/
- `stg_nflverse__snap_counts.sql` - Now reads from data/raw/nflverse/snap_counts/dt=\*/
- `stg_nflverse__ff_opportunity.sql` - Now reads from data/raw/nflverse/ff_opportunity/dt=\*/

### 3. Resolved Column Naming Questions

✅ **Data Dictionary Research**:

- Confirmed `player_id` column in player_stats **intentionally contains gsis_id values**
- This is nflverse's design (not a bug)
- Dictionary explicitly states: *"player_id": "Player's gsis_id. Use this to join to other sources"*

✅ **Crosswalk Coverage Analysis**:

- dim_player_id_xref has 63.0% gsis_id coverage, 76.5% pfr_id coverage
- snap_counts actual match rate: 80.6% (not 21.3% as initially appeared)
- Row-level unmapped rate is influenced by unpivot multiplier, not unique player coverage

✅ **Missing ff_opportunity Columns**:

- 6 advanced metrics (wopr, racr, etc.) verified NOT in nflverse dataset
- Current 32 stat types is correct
- Gap of 8 stats (88 vs 96) is expected and acceptable

### 4. Added DuckDB to .gitignore

✅ Explicitly added persistent database files:

```gitignore
dbt/**/target/*.duckdb
dbt/**/target/*.duckdb.wal
```

## Current Architecture

### Data Flow (Production-Ready)

```
Raw Sources (nflverse)
  ↓ load_nflverse() via src/ingest/nflverse/shim.py
data/raw/nflverse/{dataset}/dt=YYYY-MM-DD/{dataset}_{hash}.parquet
  ↓ dbt staging models (read_parquet with dt=* glob)
stg_nflverse__{dataset} views
  ↓ UNION ALL
fact_player_stats table (901K rows, 88 stat types)
```

### Path Structure (Mirrors GCS)

```
data/raw/nflverse/
├── weekly/dt=2025-09-28/          # 2023 season (18,643 rows) - OLD DATA
├── snap_counts/dt=2025-09-30/     # 2024 season (fresh)
├── ff_opportunity/dt=2025-09-30/  # 2024 season (fresh)
└── ff_playerids/dt=2025-09-30/    # Complete (24,266 rows → 12,133 unique)
```

## Key Findings

### Column Naming is Intentional

**Issue**: `player_id` column actually contains gsis_id
**Resolution**: ✅ This is correct per nflverse schema design

- Data dictionary: `data/data_dictionaries/nflreadr_dictionaries/dictionary_player_stats.json`
- Field definition: `"player_id": "Player's gsis_id"`
- Our workaround (aliasing as `gsis_id_raw`) is appropriate

### Crosswalk Coverage Better Than Expected

**snap_counts Analysis**:

- 773 unique pfr_player_id in sample
- 623 matched in crosswalk (80.6% rate)
- Previous 21.3% unmapped was row-level (inflated by 6x unpivot)
- Player-level coverage is much better

**Overall Coverage**:

| ID Type | Players in Crosswalk | Coverage    |
| ------- | -------------------- | ----------- |
| mfl_id  | 12,133 (100%)        | Primary key |
| gsis_id | 7,648                | 63.0%       |
| pfr_id  | 9,287                | 76.5%       |
| Both    | 7,475                | 61.6%       |

### Missing Datasets in data/raw

⚠️ **IMPORTANT**: data/raw contains OLD data from previous sessions:

- `weekly`: 2023 season only (dt=2025-09-28)
- Other datasets loaded fresh today (dt=2025-09-30)

**Action needed**: Load fresh 2024 weekly data:

```bash
PYTHONPATH=. uv run python -c "
from src.ingest.nflverse.shim import load_nflverse
load_nflverse('weekly', seasons=[2024], out_dir='data/raw/nflverse')
"
```

## Implementation Checklist Updates

### ✅ Completed

- [x] Load ff_playerids, snap_counts, ff_opportunity to data/raw with dt= partitions
- [x] Update all staging model paths to data/raw structure
- [x] Rebuild fact_player_stats successfully
- [x] Add DuckDB files to .gitignore
- [x] Research and resolve column naming questions via data dictionaries
- [x] Analyze crosswalk coverage (better than expected)

### ⏳ Next Steps

- [ ] Load fresh 2024 weekly data to data/raw
- [ ] Verify mixed-season issue resolved after fresh load
- [ ] Add grain test to fact_player_stats
- [ ] Add FK and enum tests
- [ ] Create schema.yml documentation

## Production Readiness Status

### ✅ Production-Ready

1. **Data paths**: Using proper `data/raw/{provider}/{dataset}/dt=*/` structure
1. **Partitioning**: dt= partitions following spec conventions
1. **Metadata**: \_meta.json files generated with lineage
1. **Crosswalk**: mfl_id as canonical player_id (ADR-010)
1. **Fact table**: Single consolidated table (ADR-009)
1. **Git hygiene**: DuckDB artifacts in .gitignore

### ⚠️ Needs Attention

1. **Data freshness**: Load current season data to data/raw
1. **Testing**: Add dbt tests (grain, FK, enum)
1. **Documentation**: Add schema.yml for all models
1. **Validation**: Verify unmapped player rate with fresh data

## Questions Answered

### Q: Why does player_id column contain gsis_id?

**A**: ✅ Intentional per nflverse design. Data dictionary explicitly documents this.

### Q: Why is snap_counts unmapped rate high?

**A**: ✅ Player-level coverage is 80.6%. Row-level rate (21.3%) is inflated by unpivot multiplier (6x).

### Q: Are we missing ff_opportunity columns?

**A**: ✅ No - 6 advanced metrics (wopr, racr, etc.) don't exist in nflverse dataset. 32 stats is correct.

### Q: Should staging use samples/ or data/raw/?

**A**: ✅ data/raw/ for production (now implemented). Samples/ is for schema validation only.

### Q: How to improve snap_counts coverage?

**A**: Could do two-step mapping (pfr_id → gsis_id → mfl_id) but current 80.6% is acceptable.

## Files Modified

### Staging Models

- [dbt/ff_analytics/models/staging/stg_nflverse\_\_player_stats.sql](../../dbt/ff_analytics/models/staging/stg_nflverse__player_stats.sql) - Updated path
- [dbt/ff_analytics/models/staging/stg_nflverse\_\_snap_counts.sql](../../dbt/ff_analytics/models/staging/stg_nflverse__snap_counts.sql) - Updated path
- [dbt/ff_analytics/models/staging/stg_nflverse\_\_ff_opportunity.sql](../../dbt/ff_analytics/models/staging/stg_nflverse__ff_opportunity.sql) - Updated path

### Configuration

- [.gitignore](../../.gitignore) - Added explicit DuckDB entries

### Documentation

- This handoff document

## Next Session Recommendations

### Priority 1: Fresh Data (~5 min)

```bash
# Load 2024 weekly stats
PYTHONPATH=. uv run python -c "
from src.ingest.nflverse.shim import load_nflverse
load_nflverse('weekly', seasons=[2024], out_dir='data/raw/nflverse')
"

# Rebuild fact table
uv run dbt run --project-dir dbt/ff_analytics --profiles-dir dbt/ff_analytics --select fact_player_stats
```

### Priority 2: Add Tests (~20 min)

1. **Grain test**: unique(player_id, game_id, stat_name, provider, measure_domain, stat_kind)
1. **FK test**: player_id → dim_player_id_xref.player_id (allow -1)
1. **Enum tests**: stat_kind, measure_domain, provider
1. **Not null tests**: Core grain columns

### Priority 3: Schema Documentation (~15 min)

Create schema.yml files for:

- fact_player_stats (grain, columns, tests)
- All staging models (sources, columns, tests)

### Priority 4: Phase 3 Marts (~60 min)

- mart_real_world_actuals_weekly
- mart_fantasy_actuals_weekly (apply scoring)
- Snap efficiency analysis
- Variance analysis (actual vs expected)

## Success Metrics

✅ **Achieved**:

- All staging models use production paths
- fact_player_stats builds successfully (901K rows, 88 stats)
- Column naming questions resolved via data dictionaries
- Crosswalk coverage analyzed and validated (80.6% for snap_counts)
- DuckDB files properly gitignored

⏳ **Pending**:

- Fresh 2024 data loaded across all sources
- dbt tests passing
- Schema documentation complete

______________________________________________________________________

**Next developer**: Data paths are production-ready! All staging models now use `data/raw/nflverse/{dataset}/dt=*/` structure. Key insight: nflverse's `player_id` column intentionally contains gsis_id (verified via data dictionaries). Load fresh 2024 weekly data, add tests, then proceed to Phase 3 marts.

**Build commands**:

```bash
# Load fresh data
make samples-nflverse DATASETS=weekly SEASONS=2024  # Or use shim directly

# Rebuild
uv run dbt build --project-dir dbt/ff_analytics --profiles-dir dbt/ff_analytics --select fact_player_stats+

# Check results
uv run python -c "
import duckdb
conn = duckdb.connect('dbt/ff_analytics/target/dev.duckdb', read_only=True)
print(conn.execute('SELECT COUNT(*), COUNT(DISTINCT stat_name) FROM fact_player_stats').fetchall())
"
```
