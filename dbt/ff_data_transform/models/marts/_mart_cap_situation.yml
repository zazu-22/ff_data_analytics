version: 2

models:
  - name: mart_cap_situation
    description: |
      Comprehensive cap space analysis by franchise and season.

      Grain: franchise_id, season
      Purpose: Support FASA bid planning and roster decisions

      Key features:
      - Reported cap space (source of truth from Commissioner)
      - Calculated cap space (for reconciliation)
      - Active contracts and dead cap breakdowns
      - 5-year forward view (2025-2029)

    columns:
      - name: franchise_id
        description: Franchise identifier
        data_tests:
          - not_null
          - relationships:
              arguments:
                to: ref('dim_franchise')
                field: franchise_id

      - name: franchise_name
        description: Franchise name
        data_tests:
          - not_null

      - name: owner_name
        description: Owner/GM name - use this for filtering in notebooks (e.g., WHERE owner_name = 'Jason')
        data_tests:
          - not_null

      - name: division
        description: League division (North/South/etc)

      - name: season
        description: Fantasy season year
        data_tests:
          - not_null

      - name: cap_space_available
        description: Cap space available for new contracts (use this for decisions)
        data_tests:
          - not_null

      - name: base_cap
        description: "Starting cap space each season ($250)"

      - name: cap_space_available_reported
        description: "Cap space available per Commissioner sheet"

      - name: dead_cap_reported
        description: "Dead cap per Commissioner sheet"

      - name: traded_cap_net
        description: "Net cap space traded (positive = acquired, negative = sent)"

      - name: active_contracts_total
        description: "Sum of active contract obligations from contracts_active"

      - name: dead_cap_calculated
        description: "Calculated dead cap from contracts_cut"

      - name: cap_space_available_calculated
        description: "Calculated available cap space (base - active - dead + traded)"

      - name: reconciliation_difference
        description: "Difference between reported and calculated cap space (should be ~0)"

      - name: asof_date
        description: "Date when this cap situation snapshot was taken"

    data_tests:
      - dbt_utils.unique_combination_of_columns:
          arguments:
            combination_of_columns:
              - franchise_id
              - season
      - dbt_utils.expression_is_true:
          arguments:
            expression: "abs(reconciliation_difference) <= 20"
            config:
              severity: error
              error_if: ">0"
          name: cap_reconciliation_within_tolerance
