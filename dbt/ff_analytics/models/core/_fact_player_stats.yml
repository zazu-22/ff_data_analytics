version: 2

models:
  - name: fact_player_stats
    description: |
      Consolidated fact table for all NFL player statistics across multiple sources.

      Combines base player stats (passing, rushing, receiving, defense), snap counts,
      and fantasy opportunity metrics into a single long-form table following the 2x2
      stat model (actual vs projected Ã— real-world vs fantasy).

      **Grain**: One row per player per game per stat per provider
      **Sources**: nflverse (player_stats, snap_counts, ff_opportunity)
      **Seasons**: 2023-2025 (2.7M rows, 109 stat types)
      **Architecture**: ADR-009 (single consolidated fact table), ADR-010 (mfl_id canonical identity)

    columns:
      - name: player_id
        description: |
          Canonical player identifier (mfl_id from dim_player_id_xref).
          Maps to 19 fantasy platform provider IDs.
          Value of -1 indicates unmapped player (no crosswalk match).
        tests:
          - not_null
          - relationships:
              arguments:
                to: ref('dim_player_id_xref')
                field: mfl_id
              config:
                where: "player_id != -1"  # Allow unmapped players

      - name: player_key
        description: |
          Composite player identifier ensuring grain uniqueness.
          - Mapped players: player_key = player_id (canonical mfl_id as varchar)
          - Unmapped players: player_key = raw provider ID (gsis_id or pfr_id)
          - Unknown players: player_key = 'UNKNOWN_' || game_id (fail-safe)

          This prevents duplicate grain violations when multiple unmapped players
          appear in the same game (e.g., depth TEs without crosswalk entries).
        tests:
          - not_null

      - name: game_id
        description: |
          Game identifier. For player_stats: surrogate key (season_week_team_opponent).
          For snap_counts/ff_opportunity: nflverse game_id.
        tests:
          - not_null

      - name: season
        description: NFL season year (2020-2025)
        tests:
          - not_null
          - accepted_values:
              arguments:
                values: [2020, 2021, 2022, 2023, 2024, 2025]

      - name: week
        description: Week number (1-22, includes playoffs)
        tests:
          - not_null

      - name: season_type
        description: |
          Season type: REG (regular season), POST (playoffs generic),
          WC (wild card), DIV (divisional), CON (conference), SB (super bowl), PRE (preseason)
        tests:
          - not_null
          - accepted_values:
              arguments:
                values: ['REG', 'POST', 'WC', 'DIV', 'CON', 'SB', 'PRE']

      - name: position
        description: |
          Player position. Fantasy-relevant positions: QB, RB, WR, TE, K.
          Non-fantasy positions include: T, G, C, OL, LS, DE, DT, LB, CB, S, etc.
          Used to filter grain tests to fantasy-relevant players only.
        tests:
          - not_null

      - name: stat_name
        description: |
          Name of the statistic (e.g., passing_yards, receptions, offense_snaps, fg_made).
          109 unique stat types across all sources:
          - 71 base stats (passing, rushing, receiving, defense, kicking)
          - 6 snap stats (offense_snaps, offense_pct, defense_snaps, defense_pct, st_snaps, st_pct)
          - 32 opportunity stats (*_exp, *_diff, air_yards, attempt metrics)
        tests:
          - not_null

      - name: stat_value
        description: Numeric value of the statistic
        tests:
          - not_null

      - name: measure_domain
        description: |
          Measurement domain (real_world or fantasy).
          Currently all values are 'real_world' (fantasy scoring applied in marts).
        tests:
          - not_null
          - accepted_values:
              arguments:
                values: ['real_world', 'fantasy']

      - name: stat_kind
        description: |
          Type of statistic (actual or projection).
          Currently all values are 'actual' (projections in separate fact table per ADR-007).
        tests:
          - not_null
          - accepted_values:
              arguments:
                values: ['actual', 'projection']

      - name: provider
        description: Data source provider (currently all 'nflverse')
        tests:
          - not_null
          - accepted_values:
              arguments:
                values: ['nflverse']

    tests:
      - dbt_utils.unique_combination_of_columns:
          arguments:
            combination_of_columns:
              - player_key
              - game_id
              - stat_name
              - provider
              - measure_domain
              - stat_kind
          config:
            severity: error
            error_if: ">0"
            where: "position IN ('QB', 'RB', 'WR', 'TE', 'K', 'FB')"  # Fantasy-relevant positions only
