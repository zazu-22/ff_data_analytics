# Multi-Source Snapshot Governance (Implementation Workspace)

**Version**: 2.0\
**Date**: 2025-11-07\
**Status**: Active

______________________________________________________________________

This directory is the working hub for planning and tracking implementation of unified snapshot governance across all data providers.

## Goals

- Establish consistent snapshot metadata and selection across all 5 sources (nflverse, sheets, ktc, ffanalytics, sleeper)
- Stabilize dbt staging with parameterized snapshot selection (baseline + latest strategies)
- Provide validation and monitoring of coverage/deltas before dbt execution
- Prepare for cloud-ready storage and comprehensive Prefect orchestration
- Implement CI-integrated validation from the start

## Implementation Approach

This implementation includes **Phase 0** for scope ratification, registry approval, and success metrics definition before beginning technical work. This ensures alignment on:

- Prefect orchestration for all 5 sources (Phases 1+2 scope)
- Snapshot registry seed as governance foundation
- Tightened freshness thresholds per source
- CI-integrated validation tooling

## Contents

### Core Planning Documents (v2.0)

- `2025-11-07_plan_v_2_0.md` — Comprehensive implementation plan with 7 phases (0-6), design decisions, success metrics, and risk mitigations
- `2025-11-07_tasks_checklist_v_2_0.md` — Execution checklist with phase-by-phase tasks and progress tracking

### Implementation Tickets

- `tickets/` — 56 standalone implementation tickets organized by phase (updated 2025-11-10 after comprehensive test analysis)
- Ticket naming: `[PHASE_ID]-[SEQUENCE]-[description].md` (e.g., `P1-001-create-snapshot-selection-macro.md`)
- Each ticket is self-contained with context, tasks, acceptance criteria, and testing guidance
- See `tickets/00-OVERVIEW.md` for tracking and priority guidance
- **Recent updates**: Added P1-023, P1-024, P1-025 (new data quality issues); removed P1-021 (now passing)

### Analysis & Harmonization

- `analysis/snapshot_governance_plan_comparison.md` — Detailed comparison of three implementation plan versions
- `analysis/snapshot_governance_harmonization_decisions.md` — Team decisions and technical selections from harmonization process

### Previous Planning Iterations

- `proposed_planning_docs/` — v1.0 planning documents preserved for reference

## Phase 0 Decisions (Ratified)

**Date**: 2025-11-09\
**Ticket**: P0-001

### Scope Confirmation

✅ **All 5 data sources in scope**: nflverse, sheets, ktc, ffanalytics, sleeper\
✅ **Prefect Phases 1+2**: Local flows with governance integration (Phases 3-4 deferred)\
✅ **Out of scope**: Cloud deployment (Prefect Phase 3-4), actual GCS migration, CI cut-over execution

### Governance Model Approved

✅ **Snapshot registry seed** approved as single source of truth\
✅ **Freshness thresholds** confirmed per source:

- Sheets/Sleeper: 1 day
- NFLverse/FFAnalytics: 2 days
- KTC: 5 days

✅ **Validation tooling** approach approved: Extend existing `tools/analyze_snapshot_coverage.py` + create `tools/validate_manifests.py` with CI integration

### Success Metrics Confirmed

From plan (lines 240-260):

- [ ] Zero hardcoded snapshot dates in all 13 staging models
- [ ] Snapshot registry tracking current/historical snapshots for all 5 sources
- [ ] Working Prefect flows for all 5 sources (local execution)
- [ ] Freshness tests providing pre-dbt safety net (all 5 sources)
- [ ] CI transition plan documented with rollback procedures
- [ ] Cloud migration blueprint complete

### Blocker Assessment

✅ **Environment setup**: Python 3.13.6 ✓, UV 0.8.8 ✓, dbt-fusion 1.10.13 ✓\
✅ **GCS authentication**: Service account key exists at `config/secrets/gcp-service-account-key.json`\
⚠️ **Prefect**: Not currently installed (will be added in Phase 4)\
✅ **dbt zero-config**: Verified working with default paths

**Mitigation**: Prefect installation deferred to Phase 4 (Orchestration). No blocker for Phases 1-3.

### Environment Configuration Created

✅ **`.env.example`**: Updated with `FF_ENV` selector and snapshot glob overrides\
✅ **`config/env_config.yaml`**: Created with local/ci/cloud path mappings for all 15 raw datasets\
✅ **`config/README.md`**: Created explaining configuration priority and zero-config approach\
✅ **`.env`**: Updated with snapshot governance variables

**Configuration priority** (highest to lowest):

1. Environment variables (explicit overrides)
2. `.env` file (user-specific)
3. `config/env_config.yaml[FF_ENV]` (environment defaults)
4. Defaults in dbt code (fallback)

**Zero-config verified**: dbt works without any configuration; paths default to `data/raw/...`

### Exit Criteria Met

✅ Team alignment on full scope and approach documented\
✅ All blockers identified with mitigation plans\
✅ Success metrics agreed upon and documented\
✅ Environment configuration framework established\
✅ Phase 0 decision log captured

**Ready to proceed to Phase 1 (Foundation)**

______________________________________________________________________

## Key Decisions

### Team Decisions (Confirmed)

1. **Prefect Orchestration Scope**: All 5 sources (nflverse, sheets, ktc, ffanalytics, sleeper) — Phases 1+2 implementation
2. **Freshness Coverage**: All 5 sources with tightened thresholds (sheets/sleeper: 1 day, nflverse/ffanalytics: 2 days, ktc: 5 days)
3. **Snapshot Registry**: Implement registry seed for governance
4. **Validation Tooling**: Extend existing `tools/analyze_snapshot_coverage.py` + create `tools/validate_manifests.py` with CI integration
5. **Phase 0 Inclusion**: Formalize kickoff decisions before implementation

### Technical Selections

- **Snapshot Selection Macro**: `snapshot_selection_strategy(source_glob, strategy, baseline_dt)` with three strategies (latest_only, baseline_plus_latest, all)
- **Sample Path Structure**: `data/raw/<source>/_samples/<dataset>/dt=YYYY-MM-DD/`
- **Freshness Tests**: `loaded_at_field: dt` with per-source warn/error thresholds
- **Documentation Priority**: Update SPEC checklist first, then create ops docs

## Phase Overview

| Phase       | Focus                  | Key Deliverables                                                     |
| ----------- | ---------------------- | -------------------------------------------------------------------- |
| **Phase 0** | Kickoff & Ratification | Scope confirmation, registry approval, success metrics               |
| **Phase 1** | Foundation             | Macro implementation, all 13 staging model updates, samples archival |
| **Phase 2** | Governance             | Registry seed, validation tooling, freshness tests (all 5 sources)   |
| **Phase 3** | Documentation          | SPEC checklist update, 6 ops docs creation                           |
| **Phase 4** | Orchestration          | 5 Prefect flows (local execution), governance integration            |
| **Phase 5** | CI Planning            | Parallel run strategy, rollback procedures                           |
| **Phase 6** | Cloud Blueprint        | GCS migration documentation (no implementation)                      |

## Success Metrics

- [ ] Zero hardcoded snapshot dates in all 13 staging models (P1-002 through P1-016)
- [ ] All current dbt test failures resolved (2,088 duplicates eliminated)
- [ ] Snapshot registry tracking current/historical snapshots for all 5 sources
- [ ] Working Prefect flows for all 5 sources (local execution)
- [ ] Freshness tests providing pre-dbt safety net (all 5 sources including Sleeper)
- [ ] CI transition plan documented with rollback procedures
- [ ] Cloud migration blueprint complete

## Related References

- `docs/spec/SPEC-1_v_2.3_implementation_checklist_v_0.md` — Authoritative implementation status
- `dbt/ff_data_transform/macros/` — Snapshot selection helpers and utilities
- `tools/analyze_snapshot_coverage.py` — Coverage analysis tool (to be extended)
- `docs/spec/prefect_dbt_sources_migration_20251026.md` — Detailed Prefect implementation guide

## Out of Scope

- Prefect Phases 3-4 (backfill orchestration, advanced monitoring, cloud deployment)
- Actual cloud migration execution (blueprint only in Phase 6)
- CI cut-over execution (planning only in Phase 5)
- Full GitHub Actions replacement
- Advanced monitoring dashboards
