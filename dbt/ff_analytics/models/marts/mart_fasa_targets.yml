version: 2

models:
  - name: mart_fasa_targets
    description: |
      Dynasty market intelligence platform for FASA bidding decisions.

      Transforms tactical FAAB into comprehensive dynasty strategy by integrating:
      1. Aging curve adjustments (position-specific peak windows, 3yr discounted value)
      2. Market efficiency scoring (model vs market gaps, buy/sell signals)
      3. Sustainability analysis (TDOE regression detection, sticky vs fluky metrics)
      4. League context & VoR (true replacement level vs rostered players)
      5. Enhanced bid recommendations (market-adjusted, contender/rebuilder strategies)

      **Grain:** player_id, asof_date

      **Refresh:** Daily (after Sleeper FA pool refresh)

      **Key Business Logic:**
      - Enhanced value score: 25% dynasty value + 20% aging + 20% market + 15% sustainability + 10% VoR + 10% recent
      - Dynasty 3yr value uses position-specific discount rates (RB:17.5%, WR:10%, QB:6.5%, TE:12.5%)
      - Market signals: STRONG_BUY (gap >25%), BUY (10-25%), HOLD (-10 to 10%), SELL (-10 to -25%), STRONG_SELL (<-25%)
      - TDOE regression: |TDOE| >= 3.0 flags 86-93% reversion probability
      - True VoR: vs median rostered RB2/WR3/TE1, not just FA pool

      **Research Foundation:** 25,000+ words, 50+ citations (docs/analytics_references/fasa_targets_research.md)

      **Legacy Compatibility:** Original value_score and bid_confidence preserved for comparison

    config:
      materialized: external
      location: "{{ env_var('EXTERNAL_ROOT', 'data/raw') }}/marts/mart_fasa_targets/dt={{ run_started_at.strftime('%Y-%m-%d') }}/data.parquet"

    columns:
      - name: player_id
        description: "Canonical player identifier (sequential surrogate, ADR-011)"
        data_tests:
          - not_null

      - name: player_key
        description: "Sleeper player ID (for reference)"

      - name: player_name
        description: "Player display name"
        data_tests:
          - not_null

      - name: position
        description: "Fantasy position"
        data_tests:
          - not_null
          - accepted_values:
              arguments:
                values: ['QB', 'RB', 'WR', 'TE']

      - name: nfl_team
        description: "Current NFL team abbreviation"

      - name: age
        description: "Player age as of current season"

      - name: nfl_experience
        description: "Years in NFL"

      - name: injury_status
        description: "Current injury designation from Sleeper"

      - name: fantasy_ppg_last_3
        description: "Fantasy points per game (last 3 games)"

      - name: fantasy_ppg_last_4
        description: "Fantasy points per game (last 4 games)"

      - name: fantasy_ppg_last_8
        description: "Fantasy points per game (last 8 games)"

      - name: fantasy_ppg_season
        description: "Fantasy points per game (season average)"

      - name: attempts_per_game_l4
        description: "Rush attempts + targets per game (last 4)"

      - name: targets_per_game_l4
        description: "Targets per game (last 4)"

      - name: ypc
        description: "Yards per carry (season)"

      - name: ypr
        description: "Yards per reception (season)"

      - name: catch_rate
        description: "Receptions / targets (season)"

      - name: target_share_l4
        description: "Team target share (last 4 games) - calculated as rec_attempt / rec_attempt_team"

      - name: rush_share_l4
        description: "Team rush share (last 4 games) - calculated as rush_attempt / rush_attempt_team"

      - name: opportunity_share_l4
        description: "Combined opportunity share (last 4 games) - weighted 60% target_share + 40% rush_share"

      - name: projected_ppg_ros
        description: "Projected fantasy points per game (rest of season)"

      - name: projected_total_ros
        description: "Projected total fantasy points (rest of season)"

      - name: weeks_remaining
        description: "Number of weeks remaining in season"

      - name: ktc_value
        description: "Keep Trade Cut dynasty value (1QB)"

      - name: ktc_rank_overall
        description: "Keep Trade Cut overall rank"

      - name: ktc_rank_at_position
        description: "Keep Trade Cut rank at position"

      - name: ktc_trend_4wk
        description: "KTC value change (4 weeks)"

      - name: value_score
        description: "Composite value score (0-100, higher = better target)"

      - name: points_above_replacement
        description: "Projected PPG minus 25th percentile at position"

      - name: breakout_indicator
        description: "Flag for trending usage + efficiency breakout"

      - name: regression_risk_flag
        description: "Flag for overperformance vs projections"

      - name: suggested_bid_1yr
        description: "Recommended 1-year bid amount ($)"

      - name: suggested_bid_2yr
        description: "Recommended 2-year bid amount ($)"

      - name: bid_confidence
        description: "Confidence level for bid recommendation"
        data_tests:
          - not_null
          - accepted_values:
              arguments:
                values: ['HIGH', 'MEDIUM', 'LOW']

      - name: priority_rank_overall
        description: "Overall priority rank (1 = highest value)"
        data_tests:
          - not_null

      - name: priority_rank_at_position
        description: "Position priority rank (1 = highest value)"
        data_tests:
          - not_null

      - name: asof_date
        description: "Snapshot date"
        data_tests:
          - not_null

      - name: current_week
        description: "Most recent completed NFL week"

      # ========================================================================
      # PHASE 1: AGING CURVE & DYNASTY VALUATION
      # ========================================================================

      - name: age_at_snapshot
        description: "Player age at snapshot date (calculated from birthdate)"

      - name: position_peak_age_min
        description: "Position-specific peak age minimum (RB:23, WR:26, QB:28, TE:25)"

      - name: position_peak_age_max
        description: "Position-specific peak age maximum (RB:26, WR:30, QB:33, TE:27)"

      - name: age_peak_window_flag
        description: "TRUE if player is within position-specific peak age window"

      - name: years_to_peak
        description: "Years until peak window (negative if past peak)"

      - name: age_decline_risk_score
        description: "Age decline risk (0.0=no risk, 1.0=extreme risk, >0.5=high risk)"
        data_tests:
          - dbt_utils.expression_is_true:
              arguments:
                expression: "(age_decline_risk_score >= 0.0 AND age_decline_risk_score <= 1.0) OR age_decline_risk_score IS NULL"

      - name: projected_points_year1
        description: "Projected points Year 1 (ROS this season)"

      - name: projected_points_year2
        description: "Projected points Year 2 (17 games with aging decline)"

      - name: projected_points_year3
        description: "Projected points Year 3 (17 games with compounded aging decline)"

      - name: dynasty_3yr_value
        description: "Dynasty 3-year value (sum of discounted future points)"

      - name: dynasty_discount_rate
        description: "Position-specific annual decline rate (RB:17.5%, WR:10%, QB:6.5%, TE:12.5%)"

      # ========================================================================
      # PHASE 2: MARKET EFFICIENCY SCORING
      # ========================================================================

      - name: model_value
        description: "Internal model valuation (dynasty_3yr_value in fantasy points)"

      - name: market_value
        description: "External market valuation (KTC consensus on 0-10,000 scale)"

      - name: model_percentile
        description: "Model value percentile rank within FA pool (0-100, higher=better)"

      - name: market_percentile
        description: "Market value percentile rank within FA pool (0-100, higher=better)"

      - name: value_gap_pct
        description: "Percentile gap (model_pct - market_pct). Positive=undervalued by market (BUY), Negative=overvalued (SELL)"

      - name: market_efficiency_signal
        description: "Market trading signal based on value gap"
        data_tests:
          - accepted_values:
              arguments:
                values: ['STRONG_BUY', 'BUY', 'HOLD', 'SELL', 'STRONG_SELL', 'UNKNOWN']

      - name: market_inefficiency_flag
        description: "TRUE if |value_gap_pct| > 25% (actionable arbitrage opportunity)"

      # ========================================================================
      # PHASE 3: SUSTAINABILITY ANALYSIS
      # ========================================================================

      - name: expected_tds_season
        description: "Expected TDs based on opportunity share and team context"

      - name: actual_tds_season
        description: "Actual TDs scored this season"

      - name: tdoe
        description: "Touchdowns Over Expected (actual - expected, regression signal)"

      - name: td_regression_risk_flag
        description: "TRUE if |TDOE| >= 3.0 (strong regression signal, 86-93% revert)"

      - name: td_regression_direction
        description: "Direction of expected TD regression"
        data_tests:
          - accepted_values:
              arguments:
                values: ['POSITIVE', 'NEGATIVE', 'NEUTRAL']

      - name: target_share_pct
        description: "Team target share percentage (last 4 games, r²=0.60 sticky)"

      - name: opportunity_share_pct
        description: "Combined opportunity share percentage (last 4 games, r²=0.55 sticky)"

      - name: td_rate_pct
        description: "TD rate percentage (TDs per target, r²=0.25 fluky)"

      - name: sustainability_score
        description: "Production sustainability score (0.0-1.0, higher=sticky metrics)"
        data_tests:
          - dbt_utils.expression_is_true:
              arguments:
                expression: "(sustainability_score >= 0.0 AND sustainability_score <= 1.0) OR sustainability_score IS NULL"

      # ========================================================================
      # PHASE 4: LEAGUE CONTEXT & VoR
      # ========================================================================

      - name: league_replacement_level_ppg
        description: "League replacement level PPG (median RB2/WR3/TE1)"

      - name: league_median_starter_ppg
        description: "League median starter PPG (median RB1-2/WR1-3)"

      - name: pts_above_league_replacement
        description: "True VoR (vs median rostered player, not FA pool)"

      - name: pts_vs_median_starter
        description: "Points vs median starter at position"

      - name: hypothetical_league_rank
        description: "Hypothetical league rank if rostered (1=best)"

      - name: total_league_rostered_at_pos
        description: "Total players rostered at position (context for rank)"

      - name: hypothetical_percentile
        description: "Hypothetical percentile ranking if rostered (100=best)"

      # ========================================================================
      # PHASE 5: ENHANCED SCORING & BIDS
      # ========================================================================

      - name: enhanced_value_score_v2
        description: "Enhanced value score (0-100): 25% dynasty + 20% aging + 20% market + 15% sustainability + 10% VoR + 10% recent"
        data_tests:
          - dbt_utils.expression_is_true:
              arguments:
                expression: "(enhanced_value_score_v2 >= 0 AND enhanced_value_score_v2 <= 100) OR enhanced_value_score_v2 IS NULL"

      - name: bid_confidence_v3
        description: "Enhanced bid confidence (VERY_HIGH, HIGH, MEDIUM, LOW)"
        data_tests:
          - accepted_values:
              arguments:
                values: ['VERY_HIGH', 'HIGH', 'MEDIUM', 'LOW']

      - name: suggested_bid_dynasty_3yr
        description: "Suggested bid based on 3-year dynasty value (dynasty_3yr_value / 50)"

      - name: suggested_bid_market_adjusted
        description: "Market-adjusted bid (30% premium for STRONG_BUY, 20% discount for SELL)"

      - name: suggested_bid_contender
        description: "Contender-adjusted bid (20% premium for peak age, 30% discount for decline risk)"

      - name: suggested_bid_rebuilder
        description: "Rebuilder-adjusted bid (30% premium for youth <25, 50% discount for age >27)"

    data_tests:
      - dbt_utils.unique_combination_of_columns:
          arguments:
            combination_of_columns:
              - player_id
              - asof_date
      - dbt_utils.expression_is_true:
          arguments:
            expression: "(value_score >= 0 AND value_score <= 100) OR value_score IS NULL"
